---
- name: Install prerequisites for apt repos
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
    update_cache: true

# Try Debian repos first (won't fail the play)
- name: Try install tailscale from Debian repos
  apt:
    name: tailscale
    state: present
  register: ts_install_debian
  failed_when: false

# If not available, add official Tailscale repo and install
- name: Add Tailscale apt repo key (Debian)
  shell: |
    set -euo pipefail
    install -m 0755 -d /usr/share/keyrings
    curl -fsSL https://pkgs.tailscale.com/stable/debian/trixie.noarmor.gpg \
      -o /usr/share/keyrings/tailscale-archive-keyring.gpg
  args:
    executable: /bin/bash
  when: ts_install_debian is failed or ts_install_debian.rc != 0

- name: Add Tailscale apt repo (Debian)
  copy:
    dest: /etc/apt/sources.list.d/tailscale.list
    content: |
      deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/debian trixie main
    owner: root
    group: root
    mode: "0644"
  when: ts_install_debian is failed or ts_install_debian.rc != 0

- name: Install tailscale (after adding repo if needed)
  apt:
    name: tailscale
    state: present
    update_cache: true

- name: Enable and start tailscaled
  systemd:
    name: tailscaled
    enabled: true
    state: started

- name: Show tailscale version
  command: tailscale version
  register: ts_ver
  changed_when: false
  failed_when: false

- name: Check tailscale status (json)
  command: tailscale status --json
  register: ts_status
  changed_when: false
  failed_when: false

- name: Determine if tailscale is already up
  set_fact:
    ts_is_up: '{{ (ts_status.rc == 0) and (ts_status.stdout is search(''"Self"'')) }}'

- name: Bring up tailscale with auth key + enable Tailscale SSH (first run only)
  command: >
    tailscale up
    --authkey={{ tailscale_auth_key }}
    --ssh
    {% if tailscale_hostname is defined and tailscale_hostname|length > 0 %} --hostname={{ tailscale_hostname }} {% endif %}
    {% if tailscale_tags is defined and tailscale_tags|length > 0 %} --advertise-tags={{ tailscale_tags | join(",") }} {% endif %}
  when: not ts_is_up

# Optional: enforce SSH enabled even if already up
- name: Ensure Tailscale SSH is enabled
  command: tailscale set --ssh
  when: ts_is_up
  changed_when: false
  failed_when: false

- name: Tailscale status
  debug:
    msg:
      - "tailscale version={{ ts_ver.stdout | default('unknown') }}"
      - "tailscale up={{ ts_is_up }}"
      - "tailscale status rc={{ ts_status.rc }}"
      - "tailscale0 interface should exist once up"
