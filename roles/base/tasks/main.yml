- name: Install base packages
  apt:
    update_cache: true
    name:
      - podman
      - uidmap
      - slirp4netns
      - fuse-overlayfs
      - ufw
      - curl
      - ca-certificates
      - openssl
      - jq
    state: present

- name: Create /srv layout
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ srv_base }}"
    - "{{ media_dir }}"
    - "{{ media_dir }}/movies"
    - "{{ media_dir }}/tv"
    - "{{ media_dir }}/music"
    - "{{ media_dir }}/audiobooks"
    - "{{ media_dir }}/podcasts"
    - "{{ srv_base }}/jellyfin/config"
    - "{{ srv_base }}/jellyfin/cache"
    - "{{ srv_base }}/navidrome/data"
    - "{{ srv_base }}/audiobookshelf/config"
    - "{{ srv_base }}/audiobookshelf/metadata"
    - "{{ srv_base }}/nextcloud/data"
    - "{{ srv_base }}/immich/upload"
    - "{{ srv_base }}/pihole/etc-pihole"
    - "{{ srv_base }}/pihole/etc-dnsmasq.d"
    - "{{ secrets_dir }}"

- name: Ensure /etc/containers exists
  file:
    path: /etc/containers
    state: directory
    mode: "0755"

- name: Ensure podman storage directory exists on /srv
  file:
    path: /srv/containers/storage
    state: directory
    mode: "0700"

- name: Configure rootful podman storage to use /srv (create storage.conf)
  copy:
    dest: /etc/containers/storage.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      [storage]
      driver = "overlay"
      graphroot = "/srv/containers/storage"
      runroot = "/run/containers/storage"

      [storage.options]
      mount_program = "/usr/bin/fuse-overlayfs"

- name: Restart podman socket if present (best effort)
  systemd:
    name: podman.socket
    state: restarted
  ignore_errors: true

- name: Restart podman service if present (best effort)
  systemd:
    name: podman.service
    state: restarted
  ignore_errors: true
